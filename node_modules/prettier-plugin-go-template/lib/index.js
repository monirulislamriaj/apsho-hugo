"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.printers = exports.languages = exports.parsers = void 0;
const prettier_1 = require("prettier");
const parser_html_1 = require("prettier/parser-html");
function stringHashcode(input) {
    var hash = 0, i, chr;
    for (i = 0; i < input.length; i++) {
        chr = input.charCodeAt(i);
        hash = (hash << 5) - hash + chr;
        hash |= 0;
    }
    return hash;
}
const htmlParser = parser_html_1.parsers.html;
const buildReplacement = (input) => `BPGT${stringHashcode(input)}EPGT`;
const replacements = new Map();
exports.parsers = {
    "go-template": Object.assign(Object.assign({}, htmlParser), { astFormat: "go-template", preprocess: (text) => {
            const regexp = /(?:{{.*?}}(?: *\n)?)|(?:<script(?:\n|.)*?>)((?:\n|.)*?)(?:<\/script>)/g;
            let replacedText = text.trim();
            let match;
            while ((match = regexp.exec(text)) != null) {
                const result = match[0];
                if (!result.includes("{{")) {
                    continue;
                }
                const replacement = buildReplacement(result);
                replacedText = replacedText.replace(result, replacement);
                const cleanedResult = result
                    .replace(/{{(?![-<])[ \t]*/g, "{{ ")
                    .replace(/[ \t]*(?<![->])}}/g, " }}")
                    .replace(/{{-[ \t]*/g, "{{- ")
                    .replace(/[ \t]*-}}/g, " -}}")
                    .replace(/{{<[ \t]*/g, "{{< ")
                    .replace(/[ \t]*>}}/g, " >}}")
                    .replace(/ *\n/g, "\n");
                replacements.set(replacement, cleanedResult);
            }
            return replacedText;
        } }),
};
exports.languages = [
    {
        name: "GoTemplate",
        parsers: ["go-template"],
        extensions: [
            ".go.html",
            ".gohtml",
            ".gotmpl",
            ".go.tmpl",
            ".tmpl",
            ".tpl",
            ".html.tmpl",
            ".html.tpl",
        ],
        vscodeLanguageIds: ["gotemplate", "gohtml", "GoTemplate", "GoHTML"],
    },
];
exports.printers = {
    "go-template": {
        embed: (_, __, textToDoc, options) => {
            const htmlDoc = textToDoc(options.originalText, {
                parser: "html",
            });
            const replacedHashes = [];
            const mappedDoc = prettier_1.doc.utils.mapDoc(htmlDoc, (docLeaf) => {
                if (typeof docLeaf !== "string") {
                    return docLeaf;
                }
                const regexp = /BPGT.*?EPGT/g;
                let result = docLeaf;
                let match;
                while ((match = regexp.exec(docLeaf)) != null) {
                    const hash = match[0];
                    const replacement = replacements.get(hash);
                    if (replacement) {
                        result = result.replace(hash, replacement);
                        replacedHashes.push(hash);
                    }
                }
                return result;
            });
            replacedHashes.forEach((hash) => replacements.delete(hash));
            return mappedDoc;
        },
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQWlFO0FBQ2pFLHNEQUE4RDtBQUU5RCxTQUFTLGNBQWMsQ0FBQyxLQUFhO0lBQ25DLElBQUksSUFBSSxHQUFHLENBQUMsRUFDVixDQUFDLEVBQ0QsR0FBRyxDQUFDO0lBQ04sS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ2pDLEdBQUcsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFCLElBQUksR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDO1FBQ2hDLElBQUksSUFBSSxDQUFDLENBQUM7S0FDWDtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELE1BQU0sVUFBVSxHQUFHLHFCQUFXLENBQUMsSUFBSSxDQUFDO0FBQ3BDLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLE9BQU8sY0FBYyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7QUFFL0UsTUFBTSxZQUFZLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7QUFFbEMsUUFBQSxPQUFPLEdBQUc7SUFDckIsYUFBYSxFQUFFLGdDQUNWLFVBQVUsS0FDYixTQUFTLEVBQUUsYUFBYSxFQUN4QixVQUFVLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNuQixNQUFNLE1BQU0sR0FBRyx3RUFBd0UsQ0FBQztZQUV4RixJQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDL0IsSUFBSSxLQUE2QixDQUFDO1lBRWxDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksRUFBRTtnQkFDMUMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUV4QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDMUIsU0FBUztpQkFDVjtnQkFFRCxNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDN0MsWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUV6RCxNQUFNLGFBQWEsR0FBRyxNQUFNO3FCQUV6QixPQUFPLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxDQUFDO3FCQUNuQyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxDQUFDO3FCQUdwQyxPQUFPLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQztxQkFDN0IsT0FBTyxDQUFDLFlBQVksRUFBRSxNQUFNLENBQUM7cUJBRzdCLE9BQU8sQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDO3FCQUM3QixPQUFPLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQztxQkFFN0IsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFFMUIsWUFBWSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDLENBQUM7YUFDOUM7WUFFRCxPQUFPLFlBQVksQ0FBQztRQUN0QixDQUFDLEdBQ0Y7Q0FDRixDQUFDO0FBRVcsUUFBQSxTQUFTLEdBQXNCO0lBQzFDO1FBQ0UsSUFBSSxFQUFFLFlBQVk7UUFDbEIsT0FBTyxFQUFFLENBQUMsYUFBYSxDQUFDO1FBQ3hCLFVBQVUsRUFBRTtZQUNWLFVBQVU7WUFDVixTQUFTO1lBQ1QsU0FBUztZQUNULFVBQVU7WUFDVixPQUFPO1lBQ1AsTUFBTTtZQUNOLFlBQVk7WUFDWixXQUFXO1NBQ1o7UUFDRCxpQkFBaUIsRUFBRSxDQUFDLFlBQVksRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLFFBQVEsQ0FBQztLQUNwRTtDQUNGLENBQUM7QUFFVyxRQUFBLFFBQVEsR0FBRztJQUN0QixhQUFhLEVBQVc7UUFDdEIsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDbkMsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUU7Z0JBQzlDLE1BQU0sRUFBRSxNQUFNO2FBQ2YsQ0FBQyxDQUFDO1lBRUgsTUFBTSxjQUFjLEdBQWEsRUFBRSxDQUFDO1lBRXBDLE1BQU0sU0FBUyxHQUFHLGNBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUN0RCxJQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsRUFBRTtvQkFDL0IsT0FBTyxPQUFPLENBQUM7aUJBQ2hCO2dCQUVELE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQztnQkFFOUIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDO2dCQUNyQixJQUFJLEtBQTZCLENBQUM7Z0JBR2xDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLElBQUksRUFBRTtvQkFDN0MsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUV0QixNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUUzQyxJQUFJLFdBQVcsRUFBRTt3QkFDZixNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7d0JBQzNDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7cUJBQzNCO2lCQUNGO2dCQUVELE9BQU8sTUFBTSxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1lBRUgsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRTVELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUM7S0FDRjtDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkb2MsIFBhcnNlciwgUHJpbnRlciwgU3VwcG9ydExhbmd1YWdlIH0gZnJvbSBcInByZXR0aWVyXCI7XG5pbXBvcnQgeyBwYXJzZXJzIGFzIGh0bWxQYXJzZXJzIH0gZnJvbSBcInByZXR0aWVyL3BhcnNlci1odG1sXCI7XG5cbmZ1bmN0aW9uIHN0cmluZ0hhc2hjb2RlKGlucHV0OiBzdHJpbmcpOiBudW1iZXIge1xuICB2YXIgaGFzaCA9IDAsXG4gICAgaSxcbiAgICBjaHI7XG4gIGZvciAoaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkrKykge1xuICAgIGNociA9IGlucHV0LmNoYXJDb2RlQXQoaSk7XG4gICAgaGFzaCA9IChoYXNoIDw8IDUpIC0gaGFzaCArIGNocjtcbiAgICBoYXNoIHw9IDA7XG4gIH1cbiAgcmV0dXJuIGhhc2g7XG59XG5cbmNvbnN0IGh0bWxQYXJzZXIgPSBodG1sUGFyc2Vycy5odG1sO1xuY29uc3QgYnVpbGRSZXBsYWNlbWVudCA9IChpbnB1dDogc3RyaW5nKSA9PiBgQlBHVCR7c3RyaW5nSGFzaGNvZGUoaW5wdXQpfUVQR1RgO1xuXG5jb25zdCByZXBsYWNlbWVudHMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuXG5leHBvcnQgY29uc3QgcGFyc2VycyA9IHtcbiAgXCJnby10ZW1wbGF0ZVwiOiA8UGFyc2VyPntcbiAgICAuLi5odG1sUGFyc2VyLFxuICAgIGFzdEZvcm1hdDogXCJnby10ZW1wbGF0ZVwiLFxuICAgIHByZXByb2Nlc3M6ICh0ZXh0KSA9PiB7XG4gICAgICBjb25zdCByZWdleHAgPSAvKD86e3suKj99fSg/OiAqXFxuKT8pfCg/OjxzY3JpcHQoPzpcXG58LikqPz4pKCg/OlxcbnwuKSo/KSg/OjxcXC9zY3JpcHQ+KS9nO1xuXG4gICAgICBsZXQgcmVwbGFjZWRUZXh0ID0gdGV4dC50cmltKCk7XG4gICAgICBsZXQgbWF0Y2g6IFJlZ0V4cEV4ZWNBcnJheSB8IG51bGw7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbmRpdGlvbmFsLWFzc2lnbm1lbnRcbiAgICAgIHdoaWxlICgobWF0Y2ggPSByZWdleHAuZXhlYyh0ZXh0KSkgIT0gbnVsbCkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBtYXRjaFswXTtcblxuICAgICAgICBpZiAoIXJlc3VsdC5pbmNsdWRlcyhcInt7XCIpKSB7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXBsYWNlbWVudCA9IGJ1aWxkUmVwbGFjZW1lbnQocmVzdWx0KTtcbiAgICAgICAgcmVwbGFjZWRUZXh0ID0gcmVwbGFjZWRUZXh0LnJlcGxhY2UocmVzdWx0LCByZXBsYWNlbWVudCk7XG5cbiAgICAgICAgY29uc3QgY2xlYW5lZFJlc3VsdCA9IHJlc3VsdFxuICAgICAgICAgIC8vIGNsZWFuIGV4Y2VwdCBmb3IgaHlwaGVucyBhbmQgc2hvcnRjb2Rlc1xuICAgICAgICAgIC5yZXBsYWNlKC97eyg/IVstPF0pWyBcXHRdKi9nLCBcInt7IFwiKVxuICAgICAgICAgIC5yZXBsYWNlKC9bIFxcdF0qKD88IVstPl0pfX0vZywgXCIgfX1cIilcblxuICAgICAgICAgIC8vIGNsZWFuIGh5cGhlbnNcbiAgICAgICAgICAucmVwbGFjZSgve3stWyBcXHRdKi9nLCBcInt7LSBcIilcbiAgICAgICAgICAucmVwbGFjZSgvWyBcXHRdKi19fS9nLCBcIiAtfX1cIilcblxuICAgICAgICAgIC8vIGNsZWFuIHNob3J0Y29kZXMsIGUuZy4gXCJ7ezwgICAgeWVhciAgICA+fX1cIiAtPiBcInt7PCB5ZWFyID59fVwiXG4gICAgICAgICAgLnJlcGxhY2UoL3t7PFsgXFx0XSovZywgXCJ7ezwgXCIpXG4gICAgICAgICAgLnJlcGxhY2UoL1sgXFx0XSo+fX0vZywgXCIgPn19XCIpXG5cbiAgICAgICAgICAucmVwbGFjZSgvICpcXG4vZywgXCJcXG5cIik7XG5cbiAgICAgICAgcmVwbGFjZW1lbnRzLnNldChyZXBsYWNlbWVudCwgY2xlYW5lZFJlc3VsdCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXBsYWNlZFRleHQ7XG4gICAgfSxcbiAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBsYW5ndWFnZXM6IFN1cHBvcnRMYW5ndWFnZVtdID0gW1xuICB7XG4gICAgbmFtZTogXCJHb1RlbXBsYXRlXCIsXG4gICAgcGFyc2VyczogW1wiZ28tdGVtcGxhdGVcIl0sXG4gICAgZXh0ZW5zaW9uczogW1xuICAgICAgXCIuZ28uaHRtbFwiLFxuICAgICAgXCIuZ29odG1sXCIsXG4gICAgICBcIi5nb3RtcGxcIixcbiAgICAgIFwiLmdvLnRtcGxcIixcbiAgICAgIFwiLnRtcGxcIixcbiAgICAgIFwiLnRwbFwiLFxuICAgICAgXCIuaHRtbC50bXBsXCIsXG4gICAgICBcIi5odG1sLnRwbFwiLFxuICAgIF0sXG4gICAgdnNjb2RlTGFuZ3VhZ2VJZHM6IFtcImdvdGVtcGxhdGVcIiwgXCJnb2h0bWxcIiwgXCJHb1RlbXBsYXRlXCIsIFwiR29IVE1MXCJdLFxuICB9LFxuXTtcblxuZXhwb3J0IGNvbnN0IHByaW50ZXJzID0ge1xuICBcImdvLXRlbXBsYXRlXCI6IDxQcmludGVyPntcbiAgICBlbWJlZDogKF8sIF9fLCB0ZXh0VG9Eb2MsIG9wdGlvbnMpID0+IHtcbiAgICAgIGNvbnN0IGh0bWxEb2MgPSB0ZXh0VG9Eb2Mob3B0aW9ucy5vcmlnaW5hbFRleHQsIHtcbiAgICAgICAgcGFyc2VyOiBcImh0bWxcIixcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXBsYWNlZEhhc2hlczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgY29uc3QgbWFwcGVkRG9jID0gZG9jLnV0aWxzLm1hcERvYyhodG1sRG9jLCAoZG9jTGVhZikgPT4ge1xuICAgICAgICBpZiAodHlwZW9mIGRvY0xlYWYgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICByZXR1cm4gZG9jTGVhZjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlZ2V4cCA9IC9CUEdULio/RVBHVC9nO1xuXG4gICAgICAgIGxldCByZXN1bHQgPSBkb2NMZWFmO1xuICAgICAgICBsZXQgbWF0Y2g6IFJlZ0V4cEV4ZWNBcnJheSB8IG51bGw7XG5cbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25kaXRpb25hbC1hc3NpZ25tZW50XG4gICAgICAgIHdoaWxlICgobWF0Y2ggPSByZWdleHAuZXhlYyhkb2NMZWFmKSkgIT0gbnVsbCkge1xuICAgICAgICAgIGNvbnN0IGhhc2ggPSBtYXRjaFswXTtcblxuICAgICAgICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gcmVwbGFjZW1lbnRzLmdldChoYXNoKTtcblxuICAgICAgICAgIGlmIChyZXBsYWNlbWVudCkge1xuICAgICAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoaGFzaCwgcmVwbGFjZW1lbnQpO1xuICAgICAgICAgICAgcmVwbGFjZWRIYXNoZXMucHVzaChoYXNoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSk7XG5cbiAgICAgIHJlcGxhY2VkSGFzaGVzLmZvckVhY2goKGhhc2gpID0+IHJlcGxhY2VtZW50cy5kZWxldGUoaGFzaCkpO1xuXG4gICAgICByZXR1cm4gbWFwcGVkRG9jO1xuICAgIH0sXG4gIH0sXG59O1xuIl19